# Express & SQL w. PG Show & Create

## Adding a Database to our Express App

## Rebuild Bookmarks

## Getting Started

- get your express server running
- make sure postgres is running
- in the browser go to the index route and check that it works

## Show

**IMPORTANT:** One thing that will be different with your builds is that instead of using the array position, we will be using each item's unique `id` that is generated by Postgres.

For example, looking at the data we inserted `Apartment Therapy` should have an `id` of `2`

![](./assets/id-not-array-index.png)

If we were to access it by array position it would be at array position `1`. We did this earlier for simplicity. However, there is never a guarantee that an item will be in a certain order/array position and it can change. So using the `id`, now that we have a database is critical.

**queries/bookmarks.js**

Create an async arrow function and be sure to include it in `module.exports`

```js
const db = require("../db/dbConfig.js");

const getAllBookmarks = async () => {
  try {
    const allBookmarks = await db.any("SELECT * FROM bookmarks");
    return allBookmarks;
  } catch (err) {
    return err;
  }
};

const getBookmark = async () => {};

module.exports = {
  getAllBookmarks,
  getBookmark,
};
```

Add in the functionality, we are going to get the `id` from the `req.params` in the show route (in bookmarkController - see below).

We will use `db.one` because we expect one row to be returned.

We are passing two arguments, one is the SQL query, and the second is the value coming in from the request, in this case it is the `id` of the bookmark we want to show.

We represent that `id` in the SQL query by using `$1` rather than inserting the value, as we might if it were a JavaScript string interpolation.

The reason is safety.

[Bonus Video on SQL Injection](https://www.google.com/search?q=SQL+injection+computerphile&client=safari&rls=en&ei=os7UYNnYDfOv5NoPicmJwA4&oq=SQL+injection+computerphile&gs_lcp=Cgdnd3Mtd2l6EAMyAggAMgYIABAWEB46BwgAEEcQsAM6BAgAEEM6BwgAELEDEEM6BQgAELEDOgQIABANSgQIQRgAUIcyWLNEYO5FaAJwAngAgAFriAGfCJIBBDE1LjGYAQCgAQGqAQdnd3Mtd2l6yAEIwAEB&sclient=gws-wiz&ved=0ahUKEwjZsevv8rDxAhXzF1kFHYlkAugQ4dUDCA0&uact=5)

**BONUS Cartoon**
![](https://imgs.xkcd.com/comics/exploits_of_a_mom.png)

```js
const getBookmark = async (id) => {
  try {
    const oneBookmark = await db.one("SELECT * FROM bookmarks WHERE id=$1", id);
    return oneBookmark;
  } catch (err) {
    return err;
  }
};
```

**controllers/bookmarkController.js**
Import the function

```js
const { getAllBookmarks, getBookmark } = require("../queries/bookmarks");
```

Create the show route and test it in the browser/Postman

```js
// SHOW
bookmarks.get("/:id", async (req, res) => {
  const { id } = req.params;
  res.json({ id });
});
```

Add in the query and add some logic for the 404

```js
// SHOW
// SHOW
bookmarks.get("/:id", async (req, res) => {
  const { id } = req.params;
  try {
    const bookmark = await getBookmark(id);
    res.json(bookmark);
  } catch {
    res.status(404).json({ error: "not found" });
  }
});
```

## Create

**queries/bookmarks.js**

Create an async arrow function and be sure to include it in `module.exports`

```js
const newBookmark = async (bookmark) => {
  try {
  } catch (err) {
    return err;
  }
};

module.exports = {
  getAllBookmarks,
  getBookmark,
  newBookmark,
};
```

Inserting into the database requires two arguments.

We'll use `db.one()` because we are expecting one row to be returned.

We are passing two arguments to `db.one`, the first is the SQL query, where the values are represented as `$1`, `$2` etc. In the second, we are passing an array for each value.

| SQL Value | SQL Column  |      Array Value       | Array Index |
| :-------: | :---------: | :--------------------: | :---------: |
|    $1     |    name     |    `bookmark.name`     |      0      |
|    $2     |     url     |     `bookmark.url`     |      1      |
|    $3     | is_favorite | `bookmark.is_favorite` |      2      |

```js
const newBookmark = async (bookmark) => {
  try {
    const newBookmark = await db.one(
      "INSERT INTO bookmarks (name, url, is_favorite) VALUES($1, $2, $3) RETURNING *",
      [bookmark.name, bookmark.url, bookmark.is_favorite]
    );
    return newBookmark;
  } catch (err) {
    return err;
  }
};
```

**controllers/bookmarkController.js**
Import the function

```js
const {
  getAllBookmarks,
  getBookmark,
  newBookmark,
} = require("../queries/bookmarks");
```

Create the show route and test it with Postman

Example Bookmark:

```js
{
    "name":"AV Club",
     "url": "https://www.avclub.com",
     "is_favorite": "false"
}
```

Remember to have:

- route POST /bookmarks
- `body` `raw` `JSON`

![](./assets/postman-create.png)

Now add the database call:

```js
// CREATE
bookmarks.post("/", async (req, res) => {
  const bookmark = await newBookmark(req.body);
  res.json(bookmark);
});
```

## Lab time!

Continue with Tuner
